<!DOCTYPE html>
<head>
		<title>Micron Editor ALPHA</title>
		
		<!-- hello, things taken from esprima! -->
		<!-- BTW: all this entire thing was inspired by mr. doob's three.js html editor. go check it! -->
		<meta name="viewport" content="width=device-width"/>
		<link rel="stylesheet" type="text/css" href="js/orion/built-editor.css"/>
		<link rel="stylesheet" type="text/css" href="js/style.css"/>
		<link rel="stylesheet" href="js/foundation/foundation.min.css">
			
		<style>
			#toolbar 
			{
				position: relative;
				top: 15px;
				right: -10px;
				text-align: left;
				background-color: #dfdfdf;				
			}
			
			#popup 
			{
				position: fixed;
				color: rgb(235,235,235);
				padding: 20px 20px 20px 20px;
				background-color: rgb(80,80,80);				
				top:0;
				width:25%;
				z-index:100;				
			}			
		</style>
	
		<script src="js/base.js"></script>
		<script src="js/micron.js"></script>
				
</head>
<body>

		<!-- TODO: put this thing somewhere else, external! to easily change the default code -->
		<pre id="editor" style="height: 500px">

StateGame = State.extend({

	constructor : function()
	{
		this.callParent();				
		Camera.fade( {r:0, g:0, b:0, a:1}, {r:0, g:0, b:0, a:0}, 1);
	},

	init : function()
	{
	},

	update : function(delta)
	{
		this.callParent(delta);
		if(Input.isKeyPressed(Input.KEY_A)) console.log("a!");
	},
	
	draw : function()
	{
		this.callParent();	
		Graphics.drawFullScreenRect(0.2, 0, 0.4, 1.0);		
		Graphics.drawText("Hello world!", 500, 500, 1, 1, 1, 1, 76, "Arial"); 		
	}		
});			

Core.init(2000, 1000);
Core.setState(new StateGame()); 
Core.addAsset([	"empty", "img/empty.jpg" ]);
Core.loadAndRun();

		</pre>

		<div id="popup"></div>
		<div id="toolbar"></div>

		<input id="runBtn" type="image" src="img/play.png" style="width: 24px" value="run">		
		<input id="saveBtn" type="image" src="img/save.png" style="width: 24px" value="save">
		<input id="downloadBtn" type="image" src="img/download.png" style="width: 24px" value="download">
		<input id="clearBtn" type="image" src="img/console.png" style="width: 24px" value="clear">
		<input id="newBtn" type="image" src="img/restart.png" style="width: 24px" value="new">
		<input id="helpBtn" type="image" src="img/help.png" style="width: 24px" value="help">
		
				
		<textarea id="nameArea" rows="1" cols="100">MyGame</textarea>
		
		<script src="js/orion/built-editor.min.js"></script>
		<script src="js/orion/contentassist/doctrine.js"></script>
		<script src="js/orion/contentassist/esprima.js"></script>
		<script src="js/orion/contentassist/types.js"></script>
		<script src="js/orion/contentassist/esprimaJsContentAssist.js"></script>
		<script src="js/orion/contentassist/esprimaVisitor.js"></script>
		<script src="js/orion/contentassist/proposalUtils.js"></script>	
		<script src="js/orion/customeditor.js"></script>

<script>

// todo: clean up all this shit, pretty please
require(['custom/editor'], function (editor) 
{
    var e = editor({ parent: 'editor', lang: 'js', contentassist: true });
    e.onGotoLine(9, 0);
	
	// Resize the editor
	var editorDiv = document.getElementById( 'editor' );
	editorDiv.style.height = "" + (window.innerHeight - 110) + "px";
	
	var toolbar = document.getElementById( 'toolbar' );
	var runBtn = document.getElementById( 'runBtn' );
	var saveBtn = document.getElementById( 'saveBtn' );
	var clearBtn = document.getElementById( 'clearBtn' );
	var downloadBtn = document.getElementById( 'downloadBtn' );
	var newBtn = document.getElementById( 'newBtn' );
	var helpBtn = document.getElementById( 'helpBtn' );
	
	var nameArea = document.getElementById( 'nameArea' );
	nameArea.style.width = "200px";
	
	if(localStorage.micronCode != "")
	{
		e.setText(localStorage.micronCode);
	}
	
	if(localStorage.micronGameName !== null)
	{
		nameArea.value = localStorage.micronGameName;
	}
	
	toolbar.appendChild( nameArea );
	toolbar.appendChild( runBtn );
	toolbar.appendChild( saveBtn );
	toolbar.appendChild( downloadBtn );
	toolbar.appendChild( clearBtn );
	toolbar.appendChild( newBtn );
	toolbar.appendChild( helpBtn );
	
	var isCtrl = false;
	document.onkeyup=function(e)
	{
		if(e.keyCode == 17) isCtrl = false;
	}

	GetFullGameCode = function()
	{	
		var gameName = nameArea.value;	

		// this shit is lame. really. I know.
		var PRE_HTML="";
		PRE_HTML += "<!DOCTYPE html>\n";
		PRE_HTML += "<html>\n";
		PRE_HTML += "    <head>\n";
		PRE_HTML += "        <meta charset=\"utf-8\" \/>\n";
		PRE_HTML += "        <title>" + gameName + "<\/title>\n";
		PRE_HTML += "        <style>\n";
		PRE_HTML += "            body {background-color:black}\n";
		PRE_HTML += "        </style>\n";
		PRE_HTML += "        <script src=\"js\/base.js\"><\/script>\n";
		PRE_HTML += "        <script src=\"js\/micron.js\"><\/script>\n";
		PRE_HTML += "    <\/head>\n";
		PRE_HTML += "    <body>\n";
		PRE_HTML += "        <script type=\"text\/javascript\">\n\n";	
		
		var POST_HTML="";
		POST_HTML += "        <\/script>\n";
		POST_HTML += "    <\/body>\n";
		POST_HTML += "<\/html>";	
		
		return PRE_HTML + e.getText() + POST_HTML;
	};
	
	//------------------------------------------------------------
	// todo: use FileSaver.js or someshit
	// thank you, unkown developer from stackoverflow!
	var SaveData = (function () 
	{
		var a = document.createElement("a");
		document.body.appendChild(a);
		a.style = "display: none";
		
		return function (data, fileName) 
		{
			var json = data, //JSON.stringify(data),
				blob = new Blob([json], {type: "plain/text"}),
				url = window.URL.createObjectURL(blob);
			a.href = url;
			a.download = fileName;
			a.click();
			window.URL.revokeObjectURL(url);
		};
	}());

	//------------------------------------------------------------
	
	OnSave = function()
	{
		localStorage.micronCode = e.getText();
		localStorage.micronGameName = nameArea.value;
		console.log("Game saved!");	// todo: use http://fabien-d.github.io/alertify.js/ or something	
	};
	
	OnDownload = function()
	{
		SaveData( GetFullGameCode(), nameArea.value + ".html");
	};
	
	OnRun = function()
	{
		var params = [
			'width='+ window.innerWidth,
			'height='+ window.innerHeight,
			'scrollbars=no',
			'toolbar=no',
			'menubar=no',
			'location=no',
			'status=no'
		].join(',');
			
		var newWindow = window.open("", "", params); 
		newWindow.document.write(GetFullGameCode()); 
	};
	
	// TODO: fix this shit! because now we cannot do ctrl+c/v :'(
	document.onkeydown=function(e)
	{
		if(e.keyCode == 17) isCtrl = true;
	
		if(isCtrl === true)
		{
			// CTRL-S: save the shit on the local storage
			if(e.keyCode == 83) 
			{
				e.preventDefault();
				OnSave();
			}
			// CTRL-R: run the game
			else if(e.keyCode == 82)
			{
				e.preventDefault();
				OnRun();
			}
			// CTRL-N: restore the default empty game thing
			else if(e.keyCode == 78)
			{
				// TODO
			}		
		}		
	};	
		
	runBtn.onclick = function()
	{ 
		OnRun();
	};

	saveBtn.onclick = function()
	{
		OnSave();
	};
	
	downloadBtn.onclick = function()
	{
		OnDownload();
	};
	
	clearBtn.onclick = function()
	{
		console.clear();
	};
	
	newBtn.onclick = function()
	{
		//localStorage.micronCode = "";
		//window.location = window.location;
		// todo: do this shit
		e.setText("\nStateGame = State.extend({ \n\n" +
					"    constructor : function()\n"+
					"    {\n"+
					"        this.callParent();				\n"+
					"        Camera.fade( {r:0, g:0, b:0, a:1}, {r:0, g:0, b:0, a:0}, 1);\n"+
					"    },\n"+
					"\n"+
					"    init : function()\n"+
					"    {\n"+
					"    },\n"+
					"\n"+
					"    update : function(delta)\n"+
					"    {\n"+
					"        this.callParent(delta);\n"+
					"        if(Input.isKeyPressed(Input.KEY_A)) console.log('a!');\n"+
					"    },\n"+
					"\n"+
					"    draw : function()\n"+
					"    {\n"+
					"        this.callParent();	\n"+
					"        Graphics.drawFullScreenRect(0.2, 0, 0.4, 1.0);		\n"+
					"        Graphics.drawText('Hello world!', 500, 500, 1, 1, 1, 1, 76, 'Arial'); 		\n"+
					"    }		\n"+
					"});			\n"+
					"\n"+
					"Core.init(2000, 1000);\n"+
					"Core.setState(new StateGame()); \n"+
					"Core.addAsset([	'empty', 'img/empty.jpg' ]);\n"+
					"Core.loadAndRun();\n");
		OnSave();
	};
	
	// NOTE: the next 2 functions were heavily "inspired" (again) by three.js html live editor. Yeah.
	helpBtn.onclick = function()
	{
		var dom = document.createElement( 'div' );
		dom.style.width = '400px';
		dom.style.padding = '5px';
		dom.style.border = '0px';
		dom.style.textAlign = 'center';
		dom.innerHTML = '<h1>Micron Editor<\/h1><b>Commands:</b><pre>\n* CTRL-R: run the game.\n* CTRL-S: save the game into local storage.\n* CTRL-SPACE: autocompletion (WIP).\n* API: check doc/index.html.\n* Other stuff: you will figure it out :). </pre>';
		popup.set( dom );
		popup.show();
	};

	//---------------------------------------------------------------------
	// popup

	var popup = ( function () {

		var scope = this;

		var element = document.getElementById( 'popup' );
		element.style.display = 'none';

		var buttonClose = ( function () {
			var svg = document.createElementNS( 'http://www.w3.org/2000/svg', 'svg' );
			svg.setAttribute( 'width', 32 );
			svg.setAttribute( 'height', 32 );

			var path = document.createElementNS( 'http://www.w3.org/2000/svg', 'path' );
			path.setAttribute( 'd', 'M 9,12 L 11,10 L 15,14 L 19,10 L 21,12 L 17,16 L 21,20 L 19,22 L 15,18 L 11,22 L 9,20 L 13,16' );
			path.setAttribute( 'fill', 'rgb(235,235,235)' );
			svg.appendChild( path );
			return svg;
		})();

		buttonClose.style.position = 'absolute';
		buttonClose.style.top = '5px';
		buttonClose.style.right = '5px';
		buttonClose.style.cursor = 'pointer';
		buttonClose.addEventListener( 'click', function ( event ) 
		{
			scope.hide();
		}, false );
		element.appendChild( buttonClose );

		var content = document.createElement( 'div' );
		element.appendChild( content );

		var update = function () 
		{
			element.style.left = ( ( window.innerWidth - element.offsetWidth ) / 2 ) + 'px';
			element.style.top = ( ( window.innerHeight - element.offsetHeight ) / 2 ) + 'px';
		};

		window.addEventListener( 'load', update, false );
		window.addEventListener( 'resize', update, false );

		this.show = function () 
		{
			element.style.display = '';
			update();
		};

		this.hide = function () 
		{
			element.style.display = 'none';
		};

		this.set = function ( value ) 
		{
			while ( content.children.length > 0 ) {
				content.removeChild( content.firstChild );
			}
			content.appendChild( value );
		};
		return this;
	})();
	//----------------------------------------------------
	
});
</script>

</body>
</html>
